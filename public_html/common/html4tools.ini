<?php
/*
 * [新★会社設立.JP ツール]
 * HTML作成関連ファイル
 *
 * 更新履歴：2011/01/08	d.ishikawa	新規作成
 *
 */

/**
 * ユーザー_状況の一覧を作成する。
 *
 * @param	int		$userId				ユーザーID
 * @param	boolean	$undeleteOnly		未削除データのみ取得するか？{true:未削除データ対象/false:全データ対象}
 * @return	string	html文字列{null:取得できなかった場合}
 * @access	public
 * @since
 */
function _GetUserStatusHtml($userId, $undeleteOnly = true) {

	_Log("[_GetUserStatusHtml] start.");

	_Log("[_GetUserStatusHtml] (param) ユーザーID = '".$userId."'");
	_Log("[_GetUserStatusHtml] (param) 未削除データのみ取得するか？{true:未削除データ対象/false:全データ対象} = '".$undeleteOnly."'");


	$res = null;

	if (_IsNull($userId)) {
		_Log("[_GetUserStatusHtml] ユーザーID未設定。");
		_Log("[_GetUserStatusHtml] 結果 = '".$res."'");
		_Log("[_GetUserStatusHtml] end.");
		return $res;
	}

	$undeleteOnly4Mst = true;
	$order = "lpad(show_order,10,'0'),id";

	//システムコースマスタ
	$condition = null;
	if (isset($_SESSION[SID_LOGIN_USER_INFO])) {
		$condition = array();
		$condition['plan_id'] = $_SESSION[SID_LOGIN_USER_INFO]['usr_plan_id'];				//プランID
	}
	$mstSystemCourseList = _DB_GetList('mst_system_course', $condition, $undeleteOnly4Mst, $order, 'del_flag', 'id');
	//支払状況マスタ
	$condition = null;
	$mstPayStatusList = _DB_GetList('mst_pay_status', $condition, $undeleteOnly4Mst, $order, 'del_flag', 'id');

	//ユーザー_状況テーブル
	$condition = array();
	$condition['usr_sts_user_id'] = $userId;						//ユーザーID
	$order = null;
	$order = "usr_sts_no desc";
	$tblUserStatusList = _DB_GetList('tbl_user_status', $condition, $undeleteOnly, $order, 'usr_sts_del_flag');
	if (!_IsNull($tblUserStatusList)) {
		$bufList = array();
		foreach ($tblUserStatusList as $tusKey => $tblUserStatusInfo) {
//			$bufList[$tblUserStatusInfo['usr_sts_system_course_id']][] = $tblUserStatusInfo;
			$bufList[$tblUserStatusInfo['usr_sts_system_course_id']][$tblUserStatusInfo['usr_sts_company_id']][] = $tblUserStatusInfo;
		}
		$tblUserStatusList = $bufList;
	}

	//ユーザー_会社_関連付テーブルを検索する。
	$undeleteOnly4All = true;
	$condition4All = array();
	$condition4All['usr_cmp_rel_user_id'] = $userId;			//ユーザーID
	$order4All = "usr_cmp_rel_company_id";						//ソート順=会社IDの昇順(なんでもいいけど…)
	$tblUserCompanyRelationList = _DB_GetListByAssociative('tbl_user_company_relation', 'usr_cmp_rel_company_id', null, $condition4All, $undeleteOnly4All, $order4All, 'usr_cmp_rel_del_flag');
	$tblCompanyList = null;
	if (!_IsNull($tblUserCompanyRelationList)) {
		//会社テーブルを検索する。
//		$order4All = "cmp_company_type_id";									//ソート順=会社タイプIDの昇順
		$order4All = "cmp_company_id desc";								//ソート順=会社IDの降順
		$condition4All = array();
		$condition4All['cmp_company_id'] = $tblUserCompanyRelationList;		//会社ID
		$tblCompanyList = _DB_GetList('tbl_company', $condition4All, $undeleteOnly4All, $order4All, 'cmp_del_flag', 'cmp_company_id');
	}

	//文字をHTMLエンティティに変換する。
	$mstSystemCourseList = _HtmlSpecialCharsForArray($mstSystemCourseList);
	$mstPayStatusList = _HtmlSpecialCharsForArray($mstPayStatusList);
	$tblUserStatusList = _HtmlSpecialCharsForArray($tblUserStatusList);


	$bufAll = null;
	
	if (!_IsNull($tblCompanyList)) {
		foreach ($tblCompanyList as $tcKey => $tblCompanyInfo) {
			$cmpCompanyName = "<会社名未設定>";
			if (!_IsNull($tblCompanyInfo['cmp_company_name'])) {
				$cmpCompanyName = $tblCompanyInfo['cmp_company_name'];
				$cmpCompanyName = _SubStr($cmpCompanyName, 8);
			}
			$cmpCompanyName = htmlspecialchars($cmpCompanyName, ENT_QUOTES);

			if (!_IsNull($mstSystemCourseList)) {
				foreach ($mstSystemCourseList as $mscKey => $mstSystemCourseInfo) {
					
					//会社タイプID
					if ($tblCompanyInfo['cmp_company_type_id'] != $mstSystemCourseInfo['company_type_id']) continue;
					
					$bufSystemCourse = null;
					$systemCourseFlag = false;
//					if (isset($tblUserStatusList[$mstSystemCourseInfo['id']])) {
//						foreach ($tblUserStatusList[$mstSystemCourseInfo['id']] as $tusKey => $tblUserStatusInfo) {
					if (isset($tblUserStatusList[$mstSystemCourseInfo['id']][$tblCompanyInfo['cmp_company_id']])) {
						foreach ($tblUserStatusList[$mstSystemCourseInfo['id']][$tblCompanyInfo['cmp_company_id']] as $tusKey => $tblUserStatusInfo) {
							_Log("[_GetUserStatusHtml] システム利用期限(単位:日{null:期間制限無}) = '".SYSTEM_USE_DEADLINE."'");
							$payYmd = null;
							$deadlineYmd = null;
							$payDateFlag = false;
							switch ($mstSystemCourseInfo['id']) {
								case MST_SYSTEM_COURSE_ID_CMP://[株式会社] 株式会社設立 (システム利用料金)
								case MST_SYSTEM_COURSE_ID_LLC://[合同会社] 合同会社設立LLC (システム利用料金)

								case MST_SYSTEM_COURSE_ID_STANDARD_CMP://[スタンダードパートナープラン][株式会社] 株式会社設立 (システム利用料金)
								case MST_SYSTEM_COURSE_ID_STANDARD_LLC://[スタンダードパートナープラン][合同会社] 合同会社設立LLC (システム利用料金)
					
								case MST_SYSTEM_COURSE_ID_PLATINUM_CMP://[プラチナパートナープラン][株式会社] 株式会社設立 (システム利用料金)
								case MST_SYSTEM_COURSE_ID_PLATINUM_LLC://[プラチナパートナープラン][合同会社] 合同会社設立LLC (システム利用料金)

									//入金日の登録あるか？
									if (!_IsNull($tblUserStatusInfo['usr_sts_pay_year']) && !_IsNull($tblUserStatusInfo['usr_sts_pay_month']) && !_IsNull($tblUserStatusInfo['usr_sts_pay_day'])) {
										if (!_IsNull(SYSTEM_USE_DEADLINE)) {
											$payYear = $tblUserStatusInfo['usr_sts_pay_year'];
											$payMonth = $tblUserStatusInfo['usr_sts_pay_month'];
											$payDay = $tblUserStatusInfo['usr_sts_pay_day'];
											$payTime = mktime(0, 0, 0, $payMonth, $payDay, $payYear);
											$payYmd = sprintf('%04d/%02d/%02d', $payYear, $payMonth, $payDay);
											//入金日のNヶ月後を取得する。
											$deadlineTime = mktime(0, 0, 0, $payMonth, $payDay + SYSTEM_USE_DEADLINE, $payYear);
											$deadlineYear = date('Y', $deadlineTime);
											$deadlineMonth = date('n', $deadlineTime);
											$deadlineDay = date('j', $deadlineTime);
											$deadlineYmd = sprintf('%04d/%02d/%02d', $deadlineYear, $deadlineMonth, $deadlineDay);
		
											_Log("[_GetUserStatusHtml] 入金日 = '".$payYmd."'");
											_Log("[_GetUserStatusHtml] 期限日 = '".$deadlineYmd."'");
											_Log("[_GetUserStatusHtml] 入金日(time) = '".$payTime."'");
											_Log("[_GetUserStatusHtml] 期限日(time) = '".$deadlineTime."'");
										}
									} else {
										$payDateFlag = true;
									}
									//終了日の登録あるか？ある場合は、こちらを優先して表示する。
									if (!_IsNull($tblUserStatusInfo['usr_sts_end_year']) && !_IsNull($tblUserStatusInfo['usr_sts_end_month']) && !_IsNull($tblUserStatusInfo['usr_sts_end_day'])) {
										$deadlineYmd = sprintf('%04d/%02d/%02d', $tblUserStatusInfo['usr_sts_end_year'], $tblUserStatusInfo['usr_sts_end_month'], $tblUserStatusInfo['usr_sts_end_day']);
									}
									break;
							}
		
							$buf = null;
							$buf .= $cmpCompanyName;
							$buf .= " ： ";
		
		//					$buf .= $mstSystemCourseInfo['name'];
							$buf .= $mstSystemCourseInfo['name_mini'];
							$buf .= " → ";
							$buf .= $mstPayStatusList[$tblUserStatusInfo['usr_sts_pay_status_id']]['name'];
							$buf .= " - ";
							switch ($tblUserStatusInfo['usr_sts_pay_status_id']) {
								case MST_PAY_STATUS_ID_NON:
									//未入金
									//表示しない。下で表示する。
									$buf = null;
									break;
								case MST_PAY_STATUS_ID_OK:
									//入金済
									if (!_IsNull($deadlineYmd)) {
										$buf .= $deadlineYmd;
										$buf .= "まで";
									}
									$buf .= "ご利用できます。";
									$buf .= "<span style=\"color:#00f;\">";
									$buf .= "&lt;";
									$buf .= $mstSystemCourseInfo['comment3'];
									$buf .= "&gt;";
									$buf .= "</span>";
		
									$systemCourseFlag = true;
									break;
								case MST_PAY_STATUS_ID_CANCEL:
									//キャンセル
									//表示しない。
									$buf = null;
									$payDateFlag = false;
									break;
								case MST_PAY_STATUS_ID_END:
									//期限切れ
									if (!_IsNull($deadlineYmd)) {
										$buf .= $deadlineYmd;
										$buf .= "まで";
									}
		//							$buf .= "<span style=\"color:#f00;\">";
		//							$buf .= "&lt;";
		//							$buf .= $mstSystemCourseInfo['comment2'];
		//							$buf .= "&gt;";
		//							$buf .= "</span>";
									break;
							}
		
							if ($payDateFlag) {
								//表示しない。下で表示する。
								$buf = null;
								$systemCourseFlag = false;
							}
		
							if (!_IsNull($buf)) {
								$bufSystemCourse .= "<li>";
								$bufSystemCourse .= $buf;
								$bufSystemCourse .= "</li>";
								$bufSystemCourse .= "\n";
							}
						}
					}
		
					if (!$systemCourseFlag) {
						$buf = null;
						$buf .= $cmpCompanyName;
						$buf .= " ： ";

		//				$buf .= $mstSystemCourseInfo['name'];
						$buf .= $mstSystemCourseInfo['name_mini'];
						$buf .= " → ";
						$buf .= $mstPayStatusList[MST_PAY_STATUS_ID_NON]['name'];
						$buf .= " - ";
		//				$buf .= "ご利用できません。ご入金後ご利用になれます。";
						$buf .= "ご利用できません。";
						$buf .= "<span style=\"color:#f00;\">";
						$buf .= "&lt;";
						$buf .= $mstSystemCourseInfo['comment2'];
						$buf .= "&gt;";
						$buf .= "</span>";
		
						$buf2 = null;
						$buf2 .= "<li>";
						$buf2 .= $buf;
						$buf2 .= "</li>";
						$buf2 .= "\n";
		
						$bufSystemCourse = $buf2.$bufSystemCourse;
					}
		
					$bufAll .= $bufSystemCourse;
				}
			}
		}
	}
	
	if (_IsNull($bufAll)) {
		$bufAll = "<li>株式会社、合同会社を登録すると表示されます。</li>\n";
	}

	if (!_IsNull($bufAll)) {
		$res .= "<ul>";
		$res .= "\n";
		$res .= $bufAll;
		$res .= "</ul>";
	}

	_Log("[_GetUserStatusHtml] 結果 = '".$res."'");
	_Log("[_GetUserStatusHtml] end.");
	return $res;
}

/**
 * 会社_発起人_出資額テーブル情報用
 * 入力用に表示するテーブル(フォーム)を作成する。
 *
 * @param	int		$mode				動作モード{1:入力/2:確認/3:完了/4:エラー}
 * @param	array	$xmlList			XMLを読み込んだ配列
 * @param	array	$info				入力した値が格納されている配列
 * @param	int		&$tabindex			タブインデックス
 * @param	boolean	&$stockNumErrorFlag	株数エラーフラグ{true:エラーあり/false:エラーなし}
 * @return	テーブル(フォーム)HTML文字列
 * @access  public
 * @since
 */
function _CreateTableInput4CompanyPromoterInvestment($mode, $xmlList, $info, &$tabindex, &$stockNumErrorFlag = false) {

//	if (!isset($info['condition']['_id_'])) return null;
//	if (!isset($info['condition']['_xml_name_'])) return null;

	$undeleteOnly = false;
	$companyInfo = _GetDefaultInfo($info['condition']['_xml_name_'], $info['condition']['_id_'], $undeleteOnly);
//	if (_IsNull($companyInfo)) return null;

//	if (!isset($companyInfo['tbl_company_promoter'])) return null;
//	if (!is_array($companyInfo['tbl_company_promoter'])) return null;




	//出資形態マスタ
	$condition = null;
	$order = null;
	$order .= "lpad(show_order,10,'0')";	//ソート条件=表示順の昇順
	$order .= ",id";						//ソート条件=IDの昇順
	$mstInvestmentShapeList = _DB_GetList('mst_investment_shape', $condition, false, $order, 'del_flag', 'id');

	//出資タイプマスタ
	$condition = null;
	$order = null;
	$order .= "lpad(show_order,10,'0')";	//ソート条件=表示順の昇順
	$order .= ",id";						//ソート条件=IDの昇順
	$mstInvestmentTypeList = _DB_GetList('mst_investment_type', $condition, false, $order, 'del_flag', 'id');

	//テーブルのフィールド情報を取得する。→maxlengthに使用する。
	$colInfo = _DB_GetColumnsInfo('tbl_company_promoter_investment');

	//テーブルが存在する場合、フィールドのサイズを設定する。
	$stockNumMaxlength = null;
	if (!_IsNull($colInfo)) {
		if (isset($colInfo['cmp_prm_inv_stock_num']['Size']) && !_IsNull($colInfo['cmp_prm_inv_stock_num']['Size'])) {
			$stockNumMaxlength = $colInfo['cmp_prm_inv_stock_num']['Size'];
		}
	}

	//文字をHTMLエンティティに変換する。
	$companyInfo = _HtmlSpecialCharsForArray($companyInfo);

	$res = null;


	//資本金
	$capital = $companyInfo['tbl_company']['cmp_capital'];
	//1株の単価
	$stockPrice = $companyInfo['tbl_company']['cmp_stock_price'];
	//発行株数
	$stockNum = null;
	//合計株数
	$totalStockNum = 0;

	$message = null;

	if (_IsNull($companyInfo) || _IsNull($companyInfo['tbl_company_promoter']) || !is_array($companyInfo['tbl_company_promoter'])) {
		$message .= "「出資金」を登録する場合は、「発起人」を先に登録してください。「発起人」ページで登録してください。\n";
	} else {
		foreach ($companyInfo['tbl_company_promoter'] as $pKey => $promoterInfo) {
			$resBuf = null;

			//会社ID
			$cId = $promoterInfo['cmp_prm_company_id'];
			//発起人No
			$pNo = $promoterInfo['cmp_prm_no'];

			//会社_発起人_出資額テーブル情報を取得する。
			$investmentList = $info['update']['tbl_company_promoter_investment'][$cId][$pNo];


			$resBuf .= "<div class=\"promoter_investment\">";

			$resBuf .= "<div class=\"name\">";
			$resBuf .= $promoterInfo['cmp_prm_family_name'];
			$resBuf .= "&nbsp;";
			$resBuf .= $promoterInfo['cmp_prm_first_name'];
			$resBuf .= "</div>";//<!-- End name -->

			$resBuf .= "<div class=\"details\">";


			//出資形態IDをチェックする。
			switch ($promoterInfo['cmp_prm_investment_shape_id']) {
				case MST_INVESTMENT_SHAPE_ID_CASH:
					//現金のみ
				case MST_INVESTMENT_SHAPE_ID_CASH_INKIND:
					//現金＋現物

					$resBuf .= "<div class=\"in_area\">";

					if (!isset($investmentList[MST_INVESTMENT_TYPE_ID_CASH]['investment_info'])) {
						$investmentList[MST_INVESTMENT_TYPE_ID_CASH]['investment_info'][] = array();
					}

					$no = 0;
					foreach ($investmentList[MST_INVESTMENT_TYPE_ID_CASH]['investment_info'] as $tKey => $investmentInfo) {

						$resBuf .= "<div class=\"in_set\">";

						//出資額を計算する。
						$investment = null;
						$investmentShow = null;
						$numFlag = false;
						if (!_IsNull($investmentInfo['cmp_prm_inv_stock_num'])) {
							//半角数字チェック
							if (!_IsNull($colInfo)) {
								switch ($colInfo['cmp_prm_inv_stock_num']['TypeOnly']) {
									case 'int':
									case 'bigint':
										//半角数字＋マイナス(-)チェック
										if (_IsHalfSizeNumericMinus($investmentInfo['cmp_prm_inv_stock_num'])) {
											$numFlag = true;
										}
										break;
									case 'double':
										//半角数字＋ドット(.)＋マイナス(-)チェック
										if (_IsHalfSizeNumericDotMinus($investmentInfo['cmp_prm_inv_stock_num'])) {
											$numFlag = true;
										}
										break;
								}
							}
						}
						if ($numFlag) {
							$totalStockNum += $investmentInfo['cmp_prm_inv_stock_num'];

							if (!_IsNull($stockPrice)) {
								$investment = $stockPrice * $investmentInfo['cmp_prm_inv_stock_num'];
							}
						}
						if (_IsNull($investment)) {
							$investmentShow = "-";
						} else {
							$investmentShow = number_format($investment)."円";
						}

						//比率を計算する。
						$ratio = null;
						$ratioShow = null;
						if (!_IsNull($capital)) {
							if (!_IsNull($investment)) {
								$ratio = $investment / ($capital * 10000) * 100;
							}
						}
						if (_IsNull($ratio)) {
							$ratioShow = "-";
						} else {
							$ratioShow = number_format($ratio, 1)."%";
						}


						$resBuf .= "<span class=\"stock\">";
						$resBuf .= $mstInvestmentTypeList[MST_INVESTMENT_TYPE_ID_CASH]['name'];
						$resBuf .= "&nbsp;";
						switch ($mode) {
							case 1:
								$resBuf .= "<input type=\"text\" name=\"update[tbl_company_promoter_investment][".$cId."][".$pNo."][".MST_INVESTMENT_TYPE_ID_CASH."][investment_info][".$no."][cmp_prm_inv_stock_num]\" size=\"5\" maxlength=\"".$stockNumMaxlength."\" value=\"".$investmentInfo['cmp_prm_inv_stock_num']."\" />";
								break;
							case 2:
								$stockNumShow = null;
								if ($numFlag) {
									$stockNumShow = number_format($investmentInfo['cmp_prm_inv_stock_num']);
								}
								$resBuf .= $stockNumShow;
								break;
						}
						$resBuf .= "株";
						$resBuf .= "</span>";

						$resBuf .= "<span class=\"investment\">";
						$resBuf .= $investmentShow;
						$resBuf .= "</span>";

						$resBuf .= "<span class=\"ratio\">";
						$resBuf .= $ratioShow;
						$resBuf .= "</span>";

						$resBuf .= "<span class=\"in_set_end\"></span>";

						$resBuf .= "</div>";//<!-- End in_set -->

						$no++;
					}
					$resBuf .= "</div>";//<!-- End in_area -->

					break;
			}


			//出資形態IDをチェックする。
			switch ($promoterInfo['cmp_prm_investment_shape_id']) {
				case MST_INVESTMENT_SHAPE_ID_CASH_INKIND:
					//現金＋現物
				case MST_INVESTMENT_SHAPE_ID_INKIND:
					//現物出資のみ

					$resBuf .= "<div class=\"in_area\">";

					if (!isset($investmentList[MST_INVESTMENT_TYPE_ID_INKIND]['investment_info'])) {
						$investmentList[MST_INVESTMENT_TYPE_ID_INKIND]['investment_info'][] = array();
					}

					$no = 0;
					foreach ($investmentList[MST_INVESTMENT_TYPE_ID_INKIND]['investment_info'] as $tKey => $investmentInfo) {
						$resBuf .= "<div class=\"in_set\">";

						//出資額を計算する。
						$investment = null;
						$investmentShow = null;
						$numFlag = false;
						if (!_IsNull($investmentInfo['cmp_prm_inv_stock_num'])) {
							//半角数字チェック
							if (!_IsNull($colInfo)) {
								switch ($colInfo['cmp_prm_inv_stock_num']['TypeOnly']) {
									case 'int':
									case 'bigint':
										//半角数字＋マイナス(-)チェック
										if (_IsHalfSizeNumericMinus($investmentInfo['cmp_prm_inv_stock_num'])) {
											$numFlag = true;
										}
										break;
									case 'double':
										//半角数字＋ドット(.)＋マイナス(-)チェック
										if (_IsHalfSizeNumericDotMinus($investmentInfo['cmp_prm_inv_stock_num'])) {
											$numFlag = true;
										}
										break;
								}
							}
						}
						if ($numFlag) {
							$totalStockNum += $investmentInfo['cmp_prm_inv_stock_num'];

							if (!_IsNull($stockPrice)) {
								$investment = $stockPrice * $investmentInfo['cmp_prm_inv_stock_num'];
							}
						}
						if (_IsNull($investment)) {
							$investmentShow = "-";
						} else {
							$investmentShow = number_format($investment)."円";
						}

						//比率を計算する。
						$ratio = null;
						$ratioShow = null;
						if (!_IsNull($capital)) {
							if (!_IsNull($investment)) {
								$ratio = $investment / ($capital * 10000) * 100;
							}
						}
						if (_IsNull($ratio)) {
							$ratioShow = "-";
						} else {
							$ratioShow = number_format($ratio, 1)."%";
						}

						$resBuf .= "<span class=\"stock\">";
						$resBuf .= $mstInvestmentTypeList[MST_INVESTMENT_TYPE_ID_INKIND]['name'];
						$resBuf .= "&nbsp;";
						switch ($mode) {
							case 1:
								$resBuf .= "<input type=\"text\" name=\"update[tbl_company_promoter_investment][".$cId."][".$pNo."][".MST_INVESTMENT_TYPE_ID_INKIND."][investment_info][".$no."][cmp_prm_inv_stock_num]\" size=\"5\" maxlength=\"".$stockNumMaxlength."\" value=\"".$investmentInfo['cmp_prm_inv_stock_num']."\" />";
								break;
							case 2:
								$stockNumShow = null;
								if ($numFlag) {
									$stockNumShow = number_format($investmentInfo['cmp_prm_inv_stock_num']);
								}
								$resBuf .= $stockNumShow;
								break;
						}
						$resBuf .= "株";
						$resBuf .= "</span>";

						$resBuf .= "<span class=\"investment\">";
						$resBuf .= $investmentShow;
						$resBuf .= "</span>";

						$resBuf .= "<span class=\"ratio\">";
						$resBuf .= $ratioShow;
						$resBuf .= "</span>";


						$resBuf .= "<span class=\"del_flag\">";
						switch ($mode) {
							case 1:
								$checked = null;
								if ($investmentInfo['cmp_prm_inv_del_flag'] == '1') $checked = "checked=\"checked\"";
								$resBuf .= "<input type=\"checkbox\" name=\"update[tbl_company_promoter_investment][".$cId."][".$pNo."][".MST_INVESTMENT_TYPE_ID_INKIND."][investment_info][".$no."][cmp_prm_inv_del_flag]\" value=\"1\" ".$checked." />";
								$resBuf .= "削除する";
								break;
							case 2:
								$resBuf .= "&nbsp;";
								break;
						}
						$resBuf .= "</span>";

						$resBuf .= "<span class=\"inkind_label\">";
						//$resBuf .= "現物出資の品名";
						$resBuf .= $xmlList['tbl_company_promoter_investment']['item_label']['cmp_prm_inv_in_kind'];

						switch ($mode) {
							case 1:
								$resBuf .= "&nbsp;";
								$resBuf .= "&nbsp;";
								$resBuf .= "<a href=\"./#TB_inline?height=400&width=500&inlineId=doc_exp_06_02\" class=\"smoothbox lk_exp\" title=\"説明：現物出資\">[説明]</a>";
								$resBuf .= "&nbsp;";
								$resBuf .= "<a href=\"./#TB_inline?height=400&width=500&inlineId=doc_exp_06_03\" class=\"smoothbox lk_exa\" title=\"見本：現物出資\">[見本]</a>";
								break;
							case 2:
								break;
						}

						$resBuf .= "</span>";

						$resBuf .= "<span class=\"inkind\">";
						switch ($mode) {
							case 1:
								$resBuf .= "<textarea name=\"update[tbl_company_promoter_investment][".$cId."][".$pNo."][".MST_INVESTMENT_TYPE_ID_INKIND."][investment_info][".$no."][cmp_prm_inv_in_kind]\" rows=\"2\" cols=\"20\" class=\"resize\">".$investmentInfo['cmp_prm_inv_in_kind']."</textarea>";
								break;
							case 2:
								$resBuf .= nl2br($investmentInfo['cmp_prm_inv_in_kind']);
								break;
						}
						$resBuf .= "</span>";

						$resBuf .= "<span class=\"in_set_end\"></span>";

						$resBuf .= "</div>";//<!-- End in_set -->

						$no++;
					}

					switch ($mode) {
						case 1:
							//$resBuf .= "<div class=\"in_button\">";
							$resBuf .= "<input class=\"in_button\" type=\"button\" name=\"add\" value=\"追加\" onclick=\"addInputAreaByObjAllParameter(this, 'div','investment_info', true);\"/>";
							//$resBuf .= "</div>";//<!-- End in_button -->
							break;
						case 2:
							break;
					}

					$resBuf .= "</div>";//<!-- End in_area -->

					break;
			}

			$resBuf .= "</div>";//<!-- End details -->

			$resBuf .= "</div>";//<!-- End promoter -->


			if (!_IsNull($res)) $res .= "\n";
			$res .= $resBuf;
		}

	}




	$resBuf1 = null;
	$resBuf1 .= "<div class=\"capital_stock_price\">";
	$resBuf1 .= "現在の設定";
	$resBuf1 .= "&nbsp;";
	$resBuf1 .= "-";
	$resBuf1 .= "&nbsp;";
	$resBuf1 .= "資本金：";
	if (_IsNull($capital)) {
		$resBuf1 .= "未設定";

		$message .= "「資本金」を登録してください。「資本金・事業年度」ページで登録してください。\n";
	} else {
		$resBuf1 .= number_format($capital)."万円";
	}
	$resBuf1 .= "&nbsp;";
	$resBuf1 .= "&nbsp;";
	$resBuf1 .= "1株の価格：";
	if (_IsNull($stockPrice)) {
		$resBuf1 .= "未設定";

		$message .= "「1株の価格」を登録してください。「資本金・事業年度」ページで登録してください。\n";
	} else {
		$resBuf1 .= number_format($stockPrice)."円";
	}
	$resBuf1 .= "&nbsp;";
	$resBuf1 .= "&nbsp;";
	$resBuf1 .= "発行株数：";
	if (_IsNull($capital) || _IsNull($stockPrice)) {
		$resBuf1 .= "-";
	} else {
		$stockNum = ($capital * 10000) / $stockPrice;
		$resBuf1 .= number_format($stockNum)."株";
	}

	switch ($mode) {
		case 1:
			$resBuf1 .= "&nbsp;";
			$resBuf1 .= "&nbsp;";
			$resBuf1 .= "<a href=\"./#TB_inline?height=400&width=500&inlineId=doc_exp_06_01\" class=\"smoothbox lk_exp\" title=\"説明：出資金\">[説明]</a>";
			break;
		case 2:
			break;
	}

	$resBuf1 .= "</div>";
	$resBuf1 .= "\n";


	if (!_IsNull($stockNum)) {
		$diff = $stockNum - $totalStockNum;
		if ($diff > 0) {
			$stockNumErrorFlag = true;
			$message .= "発行株数 ".number_format($stockNum)." 株に対し「 ".number_format($diff)." 」株足りません。\n";
			$message .= "引受株数を全体で「 ".number_format($diff)." 」増やしてください。\n";
		} elseif ($diff < 0) {
			$stockNumErrorFlag = true;
			$message .= "発行株数".number_format($stockNum)."株に対し「 ".number_format($diff*-1)." 」株多く発起人が引き受けております。\n";
			$message .= "引受株数を全体で「 ".number_format($diff*-1)." 」減らしてください。\n";
		}
	}

	$resBuf2 = null;
	if (!_IsNull($message)) {
		$resBuf2 .= "<div class=\"requiredMessage\">";
		$resBuf2 .= nl2br($message);
		$resBuf2 .= "</div>";
		$resBuf2 .= "\n";
	}



	$res = $resBuf1.$resBuf2.$res;

	return $res;
}

/**
 * 会社_発起人_出資額テーブル情報用
 * 入力用に表示するテーブル(フォーム)を作成する。
 *
 * @param	int		$mode					動作モード{1:入力/2:確認/3:完了/4:エラー}
 * @param	array	$xmlList				XMLを読み込んだ配列
 * @param	array	$info					入力した値が格納されている配列
 * @param	int		&$tabindex				タブインデックス
 * @param	boolean	&$investmentErrorFlag	出資金エラーフラグ{true:エラーあり/false:エラーなし}
 * @return	テーブル(フォーム)HTML文字列
 * @access  public
 * @since
 */
function _CreateTableInput4LlcPromoterInvestment($mode, $xmlList, $info, &$tabindex, &$investmentErrorFlag = false) {

//	if (!isset($info['condition']['_id_'])) return null;
//	if (!isset($info['condition']['_xml_name_'])) return null;

	$undeleteOnly = false;
	$companyInfo = _GetDefaultInfo($info['condition']['_xml_name_'], $info['condition']['_id_'], $undeleteOnly);
//	if (_IsNull($companyInfo)) return null;

//	if (!isset($companyInfo['tbl_company_promoter'])) return null;
//	if (!is_array($companyInfo['tbl_company_promoter'])) return null;




	//出資形態マスタ
	$condition = null;
	$order = null;
	$order .= "lpad(show_order,10,'0')";	//ソート条件=表示順の昇順
	$order .= ",id";						//ソート条件=IDの昇順
	$mstInvestmentShapeList = _DB_GetList('mst_investment_shape', $condition, false, $order, 'del_flag', 'id');

	//出資タイプマスタ
	$condition = null;
	$order = null;
	$order .= "lpad(show_order,10,'0')";	//ソート条件=表示順の昇順
	$order .= ",id";						//ソート条件=IDの昇順
	$mstInvestmentTypeList = _DB_GetList('mst_investment_type', $condition, false, $order, 'del_flag', 'id');

	//テーブルのフィールド情報を取得する。→maxlengthに使用する。
	$colInfo = _DB_GetColumnsInfo('tbl_company_promoter_investment');

	//テーブルが存在する場合、フィールドのサイズを設定する。
	$investmentMaxlength = null;
	if (!_IsNull($colInfo)) {
		if (isset($colInfo['cmp_prm_inv_investment']['Size']) && !_IsNull($colInfo['cmp_prm_inv_investment']['Size'])) {
			$investmentMaxlength = $colInfo['cmp_prm_inv_investment']['Size'];
		}
	}

	//文字をHTMLエンティティに変換する。
	$companyInfo = _HtmlSpecialCharsForArray($companyInfo);

	$res = null;


	//資本金
	$capital = $companyInfo['tbl_company']['cmp_capital'];
	//合計出資額
	$totalInvestment = 0;

	$message = null;

	if (_IsNull($companyInfo) || _IsNull($companyInfo['tbl_company_promoter']) || !is_array($companyInfo['tbl_company_promoter'])) {
		$message .= "「出資金」を登録する場合は、「社員(出資者)」を先に登録してください。「社員(出資者)」ページで登録してください。\n";
	} else {
		foreach ($companyInfo['tbl_company_promoter'] as $pKey => $promoterInfo) {
			$resBuf = null;

			//会社ID
			$cId = $promoterInfo['cmp_prm_company_id'];
			//発起人No
			$pNo = $promoterInfo['cmp_prm_no'];

			//会社_発起人_出資額テーブル情報を取得する。
			$investmentList = $info['update']['tbl_company_promoter_investment'][$cId][$pNo];

			//人格種別によって、表示する名前を設定する。
			$nameShow = null;
			switch ($promoterInfo['cmp_prm_personal_type_id']) {
				case MST_PERSONAL_TYPE_ID_PERSONAL:
					//個人
					$nameShow .= $promoterInfo['cmp_prm_family_name'];
					$nameShow .= "&nbsp;";
					$nameShow .= $promoterInfo['cmp_prm_first_name'];
					break;
				case MST_PERSONAL_TYPE_ID_CORPORATION:
					//法人(株式会社・有限会社のみ)
					$nameShow .= $promoterInfo['cmp_prm_company_name'];
					break;

			}

			$resBuf .= "<div class=\"promoter_investment\">";

			$resBuf .= "<div class=\"name\">";
			$resBuf .= $nameShow;
			$resBuf .= "</div>";//<!-- End name -->

			$resBuf .= "<div class=\"details\">";


			//出資形態IDをチェックする。
			switch ($promoterInfo['cmp_prm_investment_shape_id']) {
				case MST_INVESTMENT_SHAPE_ID_CASH:
					//現金のみ
				case MST_INVESTMENT_SHAPE_ID_CASH_INKIND:
					//現金＋現物

					$resBuf .= "<div class=\"in_area\">";

					if (!isset($investmentList[MST_INVESTMENT_TYPE_ID_CASH]['investment_info'])) {
						$investmentList[MST_INVESTMENT_TYPE_ID_CASH]['investment_info'][] = array();
					}

					$no = 0;
					foreach ($investmentList[MST_INVESTMENT_TYPE_ID_CASH]['investment_info'] as $tKey => $investmentInfo) {

						$resBuf .= "<div class=\"in_set\">";

						$investment = null;
						$numFlag = false;
						if (!_IsNull($investmentInfo['cmp_prm_inv_investment'])) {
							//半角数字チェック
							if (!_IsNull($colInfo)) {
								switch ($colInfo['cmp_prm_inv_investment']['TypeOnly']) {
									case 'int':
									case 'bigint':
										//半角数字＋マイナス(-)チェック
										if (_IsHalfSizeNumericMinus($investmentInfo['cmp_prm_inv_investment'])) {
											$numFlag = true;
										}
										break;
									case 'double':
										//半角数字＋ドット(.)＋マイナス(-)チェック
										if (_IsHalfSizeNumericDotMinus($investmentInfo['cmp_prm_inv_investment'])) {
											$numFlag = true;
										}
										break;
								}
							}
						}
						if ($numFlag) {
							$totalInvestment += $investmentInfo['cmp_prm_inv_investment'];
							$investment = $investmentInfo['cmp_prm_inv_investment'];
						}

						//比率を計算する。
						$ratio = null;
						$ratioShow = null;
						if (!_IsNull($capital)) {
							if (!_IsNull($investment)) {
								$ratio = $investment / $capital * 100;
							}
						}
						if (_IsNull($ratio)) {
							$ratioShow = "-";
						} else {
							$ratioShow = number_format($ratio, 1)."%";
						}


//						$resBuf .= "<span class=\"stock\">";
						$resBuf .= "<span class=\"investment investment_4_llc\">";
						$resBuf .= $mstInvestmentTypeList[MST_INVESTMENT_TYPE_ID_CASH]['name'];
						$resBuf .= "&nbsp;";
						switch ($mode) {
							case 1:
								$resBuf .= "<input type=\"text\" name=\"update[tbl_company_promoter_investment][".$cId."][".$pNo."][".MST_INVESTMENT_TYPE_ID_CASH."][investment_info][".$no."][cmp_prm_inv_investment]\" size=\"5\" maxlength=\"".$investmentMaxlength."\" value=\"".$investmentInfo['cmp_prm_inv_investment']."\" />";
								break;
							case 2:
								$investmentShow = null;
								if ($numFlag) {
									$investmentShow = number_format($investmentInfo['cmp_prm_inv_investment']);
								}
								$resBuf .= $investmentShow;
								break;
						}
//						$resBuf .= "万円";
						$resBuf .= "円";
						$resBuf .= "</span>";

//						$resBuf .= "<span class=\"investment\">";
//						$resBuf .= $investmentShow;
//						$resBuf .= "</span>";

						$resBuf .= "<span class=\"ratio\">";
						$resBuf .= $ratioShow;
						$resBuf .= "</span>";

						$resBuf .= "<span class=\"in_set_end\"></span>";

						$resBuf .= "</div>";//<!-- End in_set -->

						$no++;
					}
					$resBuf .= "</div>";//<!-- End in_area -->

					break;
			}


			//出資形態IDをチェックする。
			switch ($promoterInfo['cmp_prm_investment_shape_id']) {
				case MST_INVESTMENT_SHAPE_ID_CASH_INKIND:
					//現金＋現物
				case MST_INVESTMENT_SHAPE_ID_INKIND:
					//現物出資のみ

					$resBuf .= "<div class=\"in_area\">";

					if (!isset($investmentList[MST_INVESTMENT_TYPE_ID_INKIND]['investment_info'])) {
						$investmentList[MST_INVESTMENT_TYPE_ID_INKIND]['investment_info'][] = array();
					}

					$no = 0;
					foreach ($investmentList[MST_INVESTMENT_TYPE_ID_INKIND]['investment_info'] as $tKey => $investmentInfo) {
						$resBuf .= "<div class=\"in_set\">";

						$investment = null;
						$numFlag = false;
						if (!_IsNull($investmentInfo['cmp_prm_inv_investment'])) {
							//半角数字チェック
							if (!_IsNull($colInfo)) {
								switch ($colInfo['cmp_prm_inv_investment']['TypeOnly']) {
									case 'int':
									case 'bigint':
										//半角数字＋マイナス(-)チェック
										if (_IsHalfSizeNumericMinus($investmentInfo['cmp_prm_inv_investment'])) {
											$numFlag = true;
										}
										break;
									case 'double':
										//半角数字＋ドット(.)＋マイナス(-)チェック
										if (_IsHalfSizeNumericDotMinus($investmentInfo['cmp_prm_inv_investment'])) {
											$numFlag = true;
										}
										break;
								}
							}
						}
						if ($numFlag) {
							$totalInvestment += $investmentInfo['cmp_prm_inv_investment'];
							$investment = $investmentInfo['cmp_prm_inv_investment'];
						}

						//比率を計算する。
						$ratio = null;
						$ratioShow = null;
						if (!_IsNull($capital)) {
							if (!_IsNull($investment)) {
								$ratio = $investment / $capital * 100;
							}
						}
						if (_IsNull($ratio)) {
							$ratioShow = "-";
						} else {
							$ratioShow = number_format($ratio, 1)."%";
						}

//						$resBuf .= "<span class=\"stock\">";
						$resBuf .= "<span class=\"investment investment_4_llc\">";
						$resBuf .= $mstInvestmentTypeList[MST_INVESTMENT_TYPE_ID_INKIND]['name'];
						$resBuf .= "&nbsp;";
						switch ($mode) {
							case 1:
								$resBuf .= "<input type=\"text\" name=\"update[tbl_company_promoter_investment][".$cId."][".$pNo."][".MST_INVESTMENT_TYPE_ID_INKIND."][investment_info][".$no."][cmp_prm_inv_investment]\" size=\"5\" maxlength=\"".$investmentMaxlength."\" value=\"".$investmentInfo['cmp_prm_inv_investment']."\" />";
								break;
							case 2:
								$investmentShow = null;
								if ($numFlag) {
									$investmentShow = number_format($investmentInfo['cmp_prm_inv_investment']);
								}
								$resBuf .= $investmentShow;
								break;
						}
//						$resBuf .= "万円";
						$resBuf .= "円";
						$resBuf .= "</span>";

//						$resBuf .= "<span class=\"investment\">";
//						$resBuf .= $investmentShow;
//						$resBuf .= "</span>";

						$resBuf .= "<span class=\"ratio\">";
						$resBuf .= $ratioShow;
						$resBuf .= "</span>";


						$resBuf .= "<span class=\"del_flag\">";
						switch ($mode) {
							case 1:
								$checked = null;
								if ($investmentInfo['cmp_prm_inv_del_flag'] == '1') $checked = "checked=\"checked\"";
								$resBuf .= "<input type=\"checkbox\" name=\"update[tbl_company_promoter_investment][".$cId."][".$pNo."][".MST_INVESTMENT_TYPE_ID_INKIND."][investment_info][".$no."][cmp_prm_inv_del_flag]\" value=\"1\" ".$checked." />";
								$resBuf .= "削除する";
								break;
							case 2:
								$resBuf .= "&nbsp;";
								break;
						}
						$resBuf .= "</span>";

						$resBuf .= "<span class=\"inkind_label\">";
						//$resBuf .= "現物出資の品名";
						$resBuf .= $xmlList['tbl_company_promoter_investment']['item_label']['cmp_prm_inv_in_kind'];

						switch ($mode) {
							case 1:
								$resBuf .= "&nbsp;";
								$resBuf .= "&nbsp;";
								$resBuf .= "<a href=\"./#TB_inline?height=400&width=500&inlineId=doc_exp_05_01\" class=\"smoothbox lk_adv\" title=\"注意：現物出資\">[注意]</a>";
								$resBuf .= "&nbsp;";
								$resBuf .= "<a href=\"./#TB_inline?height=400&width=500&inlineId=doc_exp_05_02\" class=\"smoothbox lk_exp\" title=\"説明：現物出資\">[説明]</a>";
								$resBuf .= "&nbsp;";
								$resBuf .= "<a href=\"./#TB_inline?height=400&width=500&inlineId=doc_exp_05_03\" class=\"smoothbox lk_exa\" title=\"見本：現物出資\">[見本]</a>";
								break;
							case 2:
								break;
						}

						$resBuf .= "</span>";

						$resBuf .= "<span class=\"inkind\">";
						switch ($mode) {
							case 1:
								$resBuf .= "<textarea name=\"update[tbl_company_promoter_investment][".$cId."][".$pNo."][".MST_INVESTMENT_TYPE_ID_INKIND."][investment_info][".$no."][cmp_prm_inv_in_kind]\" rows=\"2\" cols=\"20\" class=\"resize\">".$investmentInfo['cmp_prm_inv_in_kind']."</textarea>";
								break;
							case 2:
								$resBuf .= nl2br($investmentInfo['cmp_prm_inv_in_kind']);
								break;
						}
						$resBuf .= "</span>";

						$resBuf .= "<span class=\"in_set_end\"></span>";

						$resBuf .= "</div>";//<!-- End in_set -->

						$no++;
					}

					switch ($mode) {
						case 1:
							//$resBuf .= "<div class=\"in_button\">";
							$resBuf .= "<input class=\"in_button\" type=\"button\" name=\"add\" value=\"追加\" onclick=\"addInputAreaByObjAllParameter(this, 'div','investment_info', true);\"/>";
							//$resBuf .= "</div>";//<!-- End in_button -->
							break;
						case 2:
							break;
					}

					$resBuf .= "</div>";//<!-- End in_area -->

					break;
			}

			$resBuf .= "</div>";//<!-- End details -->

			$resBuf .= "</div>";//<!-- End promoter -->


			if (!_IsNull($res)) $res .= "\n";
			$res .= $resBuf;
		}

	}




	$resBuf1 = null;
	$resBuf1 .= "<div class=\"capital_stock_price\">";
	$resBuf1 .= "現在の設定";
	$resBuf1 .= "&nbsp;";
	$resBuf1 .= "-";
	$resBuf1 .= "&nbsp;";
	$resBuf1 .= "資本金：";
	if (_IsNull($capital)) {
		$resBuf1 .= "未設定";

		$message .= "「資本金」を登録してください。「資本金・事業年度」ページで登録してください。\n";
	} else {
//		$resBuf1 .= number_format($capital)."万円";
		$resBuf1 .= number_format($capital)."円";
	}
	$resBuf1 .= "</div>";
	$resBuf1 .= "\n";


	if (!_IsNull($capital)) {
		$diff = $capital - $totalInvestment;
		if ($diff > 0) {
			$investmentErrorFlag = true;
//			$message .= "資本金 ".number_format($capital)." 万円に対し「 ".number_format($diff)." 」万円足りません。\n";
//			$message .= "出資金を全体で「 ".number_format($diff)." 」万円増やしてください。\n";
			$message .= "資本金 ".number_format($capital)." 円に対し「 ".number_format($diff)." 」円足りません。\n";
			$message .= "出資金を全体で「 ".number_format($diff)." 」円増やしてください。\n";
		} elseif ($diff < 0) {
			$investmentErrorFlag = true;
//			$message .= "資本金 ".number_format($capital)." 万円に対し「 ".number_format($diff*-1)." 」万円多いです。\n";
//			$message .= "出資金を全体で「 ".number_format($diff*-1)." 」万円減らしてください。\n";
			$message .= "資本金 ".number_format($capital)." 円に対し「 ".number_format($diff*-1)." 」円多いです。\n";
			$message .= "出資金を全体で「 ".number_format($diff*-1)." 」円減らしてください。\n";
		}
	}

	$resBuf2 = null;
	if (!_IsNull($message)) {
		$resBuf2 .= "<div class=\"requiredMessage\">";
		$resBuf2 .= nl2br($message);
		$resBuf2 .= "</div>";
		$resBuf2 .= "\n";
	}



	$res = $resBuf1.$resBuf2.$res;

	return $res;
}




/**
 * サイドメニューに表示するユーザー名を取得する。
 *
 * @param	array	$loginInfo		ログイン情報
 * @return	string	html文字列{null:取得できなかった場合}
 * @access	public
 * @since
 */
function _GetLoginUserNameHtml($loginInfo) {
	if (_IsNull($loginInfo)) return null;

	$baseUrl = URL;
	$sslUrl = SSL_URL;

	$res = null;
	$res .= "<div id=\"sd_mn_user\">";
	$res .= "\n";
	$res .= "<span>";
	$res .= "ログイン会員 / ";
	$res .= "<br />";
	$res .= htmlspecialchars($loginInfo['usr_family_name']);
	$res .= " ";
	$res .= htmlspecialchars($loginInfo['usr_first_name']);
	$res .= " ";
	$res .= "様";
	$res .= "</span>";
	$res .= "\n";
	$res .= "<a href=\"".$baseUrl."/logout/\" title=\"ログアウト\">ログアウト</a>";
	$res .= "\n";
	$res .= "</div><!-- End sd_mn_user -->";


	switch ($loginInfo['usr_auth_id']) {
	case AUTH_WOOROM:
		$res .= "<div id=\"sd_mn_admin\">";
		$res .= "\n";
		$res .= "<a href=".PAGE_DIR_ADMIN_USER.">".PAGE_TITLE_ADMIN_USER."</a>";
		$res .= "\n";
		$res .= "<br />";
		$res .= "\n";
		$res .= "<a href=".PAGE_DIR_FAQ.">".PAGE_TITLE_ADMIN_FAQ."</a>";
		$res .= "\n";
		$res .= "</div><!-- End sd_mn_admin -->";
		break;
	}

	return $res;
}

/**
 * 会社設立情報の簡易一覧を作成する。
 * サイドメニューに表示する。
 *
 * @param	array	$loginInfo			ログイン情報
 * @param	int		$companyTypeId		会社タイプID
 * @param	boolean	$undeleteOnly		未削除データのみ取得するか？{true:未削除データ対象/false:全データ対象}
 * @return	string	html文字列{null:取得できなかった場合}
 * @access	public
 * @since
 */
function _GetCompanyInfoHtml($loginInfo, $companyTypeId = null, $undeleteOnly = true) {

	_Log("[_GetCompanyInfoHtml] start.");

	_Log("[_GetCompanyInfoHtml] (param) ログイン情報 = '".print_r($loginInfo, true)."'");
	_Log("[_GetCompanyInfoHtml] (param) 会社タイプID = '".$companyTypeId."'");
	_Log("[_GetCompanyInfoHtml] (param) 未削除データのみ取得するか？{true:未削除データ対象/false:全データ対象} = '".$undeleteOnly."'");


	$res = null;

	$userId = $loginInfo['usr_user_id'];

	if (_IsNull($loginInfo)) {
		_Log("[_GetCompanyInfoHtml] ログイン情報未設定。");
		_Log("[_GetCompanyInfoHtml] 結果 = '".$res."'");
		_Log("[_GetCompanyInfoHtml] end.");
		return $res;
	}
	if (_IsNull($userId)) {
		_Log("[_GetCompanyInfoHtml] ユーザーID未設定。");
		_Log("[_GetCompanyInfoHtml] 結果 = '".$res."'");
		_Log("[_GetCompanyInfoHtml] end.");
		return $res;
	}

	if (_IsNull($companyTypeId)) $companyTypeId = MST_COMPANY_TYPE_ID_CMP;

	$baseUrl = URL;
	$sslUrl = SSL_URL;

	$dir = dirname(__FILE__);
	_Log("[_GetCompanyInfoHtml] dirname(__FILE__) = '".$dir."'");

	//定款認証コースマスタ
	$condition4Mst = null;
	$undeleteOnly4Mst = true;
	$order4Mst = "lpad(show_order,10,'0'),id";
	$mstArticleCourseList = _DB_GetList('mst_article_course', $condition4Mst, $undeleteOnly4Mst, $order4Mst, 'del_flag', 'id');

	//文字をHTMLエンティティに変換する。
	$mstArticleCourseList = _HtmlSpecialCharsForArray($mstArticleCourseList);

	$title = null;
	$lastUrl = null;
	$articleUrl = null;
	switch ($companyTypeId) {
		case MST_COMPANY_TYPE_ID_CMP:
			//株式会社
			$title = "株式会社設立情報";
			$lastUrl = "/user/company/info/?step=9";
			$articleUrl = "/user/company/article/";

			$xmlName = XML_NAME_CMP;

			//自分の株式会社設立情報のみ表示する。
			$id = _GetRelationCompanyId($userId);

			$info = array();
			$info['update'] = _GetDefaultInfo($xmlName, $id, $undeleteOnly);
			$info['condition']['_xml_name_'] = $xmlName;
			$info['condition']['_id_'] = $id;

			//文字をHTMLエンティティに変換する。
			$info = _HtmlSpecialCharsForArray($info);
			_Log("[_GetCompanyInfoHtml] 会社設立情報(文字をHTMLエンティティに変換する。) = '".print_r($info,true)."'");


			$xmlName = XML_NAME_CMP_ALL;

			//XMLを読み込む。
			$xmlFile = $dir."/form_xml/".$xmlName.".xml";
			_Log("[/user/company/info/index.php] XMLファイル = '".$xmlFile."'");
			$xmlList = _GetXml($xmlFile);

			_Log("[/user/company/info/index.php] XMLファイル配列 = '".print_r($xmlList,true)."'");


			//全てのXMLを読み込む。

			//株式会社設立情報[商号(会社名)]
			$bufXmlFile = $dir."/form_xml/".XML_NAME_CMP_NAME.".xml";
			_Log("[_GetCompanyInfoHtml] XMLファイル = '".$bufXmlFile."'");
			$bufXmlList = _GetXml($bufXmlFile);
			$xmlList['tbl_company_name'] = $bufXmlList['tbl_company'];

			//株式会社設立情報[資本金・事業年度]
			$bufXmlFile = $dir."/form_xml/".XML_NAME_CMP_CAPITAL.".xml";
			_Log("[_GetCompanyInfoHtml] XMLファイル = '".$bufXmlFile."'");
			$bufXmlList = _GetXml($bufXmlFile);
			$xmlList['tbl_company_capital'] = $bufXmlList['tbl_company'];

			//株式会社設立情報[本店所在地]
			$bufXmlFile = $dir."/form_xml/".XML_NAME_CMP_ADDRESS.".xml";
			_Log("[_GetCompanyInfoHtml] XMLファイル = '".$bufXmlFile."'");
			$bufXmlList = _GetXml($bufXmlFile);
			$xmlList['tbl_company_address'] = $bufXmlList['tbl_company'];

			//株式会社設立情報[事業の目的]
			$bufXmlFile = $dir."/form_xml/".XML_NAME_CMP_PURPOSE.".xml";
			_Log("[_GetCompanyInfoHtml] XMLファイル = '".$bufXmlFile."'");
			$bufXmlList = _GetXml($bufXmlFile);
			$xmlList['tbl_company_purpose'] = $bufXmlList['tbl_company_purpose'];

			//株式会社設立情報[役員構成・任期]
			$bufXmlFile = $dir."/form_xml/".XML_NAME_CMP_BOARD_BASE.".xml";
			_Log("[_GetCompanyInfoHtml] XMLファイル = '".$bufXmlFile."'");
			$bufXmlList = _GetXml($bufXmlFile);
			$xmlList['tbl_company_board_base'] = $bufXmlList['tbl_company'];

			//株式会社設立情報[取締役]
			$bufXmlFile = $dir."/form_xml/".XML_NAME_CMP_BOARD_NAME.".xml";
			_Log("[_GetCompanyInfoHtml] XMLファイル = '".$bufXmlFile."'");
			$bufXmlList = _GetXml($bufXmlFile);
			$xmlList['tbl_company_board'] = $bufXmlList['tbl_company_board'];

			//株式会社設立情報[発起人]
			$bufXmlFile = $dir."/form_xml/".XML_NAME_CMP_PROMOTER.".xml";
			_Log("[_GetCompanyInfoHtml] XMLファイル = '".$bufXmlFile."'");
			$bufXmlList = _GetXml($bufXmlFile);
			$xmlList['tbl_company_promoter'] = $bufXmlList['tbl_company_promoter'];

			//株式会社設立情報[出資金]
			$bufXmlFile = $dir."/form_xml/".XML_NAME_CMP_PROMOTER_INVESTMENT.".xml";
			_Log("[_GetCompanyInfoHtml] XMLファイル = '".$bufXmlFile."'");
			$bufXmlList = _GetXml($bufXmlFile);
			$xmlList['tbl_company_promoter_investment'] = $bufXmlList['tbl_company_promoter_investment'];


			$info['update']['tbl_company_name'] = $info['update']['tbl_company'];
			$info['update']['tbl_company_capital'] = $info['update']['tbl_company'];
			$info['update']['tbl_company_address'] = $info['update']['tbl_company'];
			$info['update']['tbl_company_board_base'] = $info['update']['tbl_company'];


			_Log("[_GetCompanyInfoHtml] XMLファイル配列(全XMLマージ後) = '".print_r($xmlList,true)."'");
			_Log("[_GetCompanyInfoHtml] 株式会社設立情報(全XMLマージ後) = '".print_r($info,true)."'");

			$mode = 20;
			$tabindex = 0;
			$message = null;
			$errorFlag = false;
			$allShowFlag = false;


			$maincontent = null;
			$maincontent .= "<!--{_message_}-->";
			$maincontent .= "\n";
			$maincontent .= _GetFormTable($mode, $xmlList, $info, $tabindex, $loginInfo, $message, $errorFlag, $allShowFlag);


			$allErrorFlag = false;
			//株式会社設立情報[取締役]
			$requiredMessage = null;
			if (_IsNull($info['update']['tbl_company_board']) || !is_array($info['update']['tbl_company_board'])) {
				$requiredMessage .= "「取締役」を登録する場合は、「役員構成」を先に登録してください。「役員構成・任期」ページで登録してください。";
			}
			$buf = null;
			if (!_IsNull($requiredMessage)) {
				$allErrorFlag = true;
				$buf .= "<div class=\"requiredMessage\">";
				$buf .= nl2br($requiredMessage);
				$buf .= "</div>";
				$buf .= "\n";
			}
			$maincontent = str_replace('{form_info_cmp_board_name}', $buf, $maincontent);

			//株式会社設立情報[出資金]
			$mode4Promoter = 2;
			$buf = _CreateTableInput4CompanyPromoterInvestment($mode4Promoter, $xmlList, $info, $tabindex);
			$maincontent = str_replace('{form_info_cmp_promoter_investment}', $buf, $maincontent);
			if (preg_match('/class=\\"requiredMessage\\"/', $buf)) {
				$allErrorFlag = true;
			}

			foreach ($xmlList as $xKey => $xmlInfo) {
				$repKey = null;
				switch ($xKey) {
					case 'tbl_company_name';
						$repKey = '<!--{_form_info_cmp_name_}-->';
						break;
					case 'tbl_company_capital';
						$repKey = '<!--{_form_info_cmp_capital_}-->';
						break;
					case 'tbl_company_address';
						$repKey = '<!--{_form_info_cmp_address_}-->';
						break;
					case 'tbl_company_purpose';
						$repKey = '<!--{_form_info_cmp_purpose_}-->';
						break;
					case 'tbl_company_board_base';
						$repKey = '<!--{_form_info_cmp_board_base_}-->';
						break;
					case 'tbl_company_board';
						$repKey = '<!--{_form_info_cmp_board_name_}-->';
						break;
					case 'tbl_company_promoter';
						$repKey = '<!--{_form_info_cmp_promoter_}-->';
						break;
					case 'tbl_company_promoter_investment';
						$repKey = '<!--{_form_info_cmp_promoter_investment_}-->';
						break;
					default:
						continue 2;
				}

				$bufXmlList = array();
				$bufXmlList[$xKey] = $xmlInfo;
				//入力値チェック
				$bufMessage = null;
				$bufMessage .= _CheackInputAll($bufXmlList, $info);
				if (!_IsNull($bufMessage)) {
					$allErrorFlag = true;
					$buf = null;
					$buf .= "<div class=\"requiredMessage\">";
					$buf .= "未入力項目があります。";//.$bufMessage;
					$buf .= "</div>";
					$buf .= "\n";
					$maincontent = str_replace($repKey, $buf, $maincontent);
				}
			}

			$buf = null;
			$maincontent = str_replace('<!--{_message_}-->', $buf, $maincontent);
			break;
		case MST_COMPANY_TYPE_ID_LLC:
			//合同会社
			$title = "合同会社設立LLC情報";
			$lastUrl = "/user/llc/info/?step=7";
			$articleUrl = "/user/llc/article/";

			$xmlName = XML_NAME_LLC;

			//自分の合同会社設立情報のみ表示する。
			$id = _GetRelationLlcId($userId);

			$info = array();
			$info['update'] = _GetDefaultInfo($xmlName, $id, $undeleteOnly);
			$info['condition']['_xml_name_'] = $xmlName;
			$info['condition']['_id_'] = $id;

			//文字をHTMLエンティティに変換する。
			$info = _HtmlSpecialCharsForArray($info);
			_Log("[_GetCompanyInfoHtml] 会社設立情報(文字をHTMLエンティティに変換する。) = '".print_r($info,true)."'");


			$xmlName = XML_NAME_LLC_ALL;

			//XMLを読み込む。
			$xmlFile = $dir."/form_xml/".$xmlName.".xml";
			_Log("[_GetCompanyInfoHtml] XMLファイル = '".$xmlFile."'");
			$xmlList = _GetXml($xmlFile);

			_Log("[_GetCompanyInfoHtml] XMLファイル配列 = '".print_r($xmlList,true)."'");

			//全てのXMLを読み込む。

			//合同会社設立情報[商号(会社名)]
			$bufXmlFile = $dir."/form_xml/".XML_NAME_LLC_NAME.".xml";
			_Log("[_GetCompanyInfoHtml] XMLファイル = '".$bufXmlFile."'");
			$bufXmlList = _GetXml($bufXmlFile);
			$xmlList['tbl_company_name'] = $bufXmlList['tbl_company'];

			//合同会社設立情報[資本金・事業年度]
			$bufXmlFile = $dir."/form_xml/".XML_NAME_LLC_CAPITAL.".xml";
			_Log("[_GetCompanyInfoHtml] XMLファイル = '".$bufXmlFile."'");
			$bufXmlList = _GetXml($bufXmlFile);
			$xmlList['tbl_company_capital'] = $bufXmlList['tbl_company'];

			//合同会社設立情報[本店所在地]
			$bufXmlFile = $dir."/form_xml/".XML_NAME_LLC_ADDRESS.".xml";
			_Log("[_GetCompanyInfoHtml] XMLファイル = '".$bufXmlFile."'");
			$bufXmlList = _GetXml($bufXmlFile);
			$xmlList['tbl_company_address'] = $bufXmlList['tbl_company'];

			//合同会社設立情報[事業の目的]
			$bufXmlFile = $dir."/form_xml/".XML_NAME_LLC_PURPOSE.".xml";
			_Log("[_GetCompanyInfoHtml] XMLファイル = '".$bufXmlFile."'");
			$bufXmlList = _GetXml($bufXmlFile);
			$xmlList['tbl_company_purpose'] = $bufXmlList['tbl_company_purpose'];

			//合同会社設立情報[発起人]
			$bufXmlFile = $dir."/form_xml/".XML_NAME_LLC_PROMOTER.".xml";
			_Log("[_GetCompanyInfoHtml] XMLファイル = '".$bufXmlFile."'");
			$bufXmlList = _GetXml($bufXmlFile);
			$xmlList['tbl_company_promoter'] = $bufXmlList['tbl_company_promoter'];

			//合同会社設立情報[出資金]
			$bufXmlFile = $dir."/form_xml/".XML_NAME_LLC_PROMOTER_INVESTMENT.".xml";
			_Log("[_GetCompanyInfoHtml] XMLファイル = '".$bufXmlFile."'");
			$bufXmlList = _GetXml($bufXmlFile);
			$xmlList['tbl_company_promoter_investment'] = $bufXmlList['tbl_company_promoter_investment'];


			$info['update']['tbl_company_name'] = $info['update']['tbl_company'];
			$info['update']['tbl_company_capital'] = $info['update']['tbl_company'];
			$info['update']['tbl_company_address'] = $info['update']['tbl_company'];
			$info['update']['tbl_company_article'] = $info['update']['tbl_company'];
			$info['update']['tbl_company_board_base'] = $info['update']['tbl_company'];


			_Log("[_GetCompanyInfoHtml] XMLファイル配列(全XMLマージ後) = '".print_r($xmlList,true)."'");
			_Log("[_GetCompanyInfoHtml] 合同会社設立情報(全XMLマージ後) = '".print_r($info,true)."'");

			$mode = 20;
			$tabindex = 0;
			$message = null;
			$errorFlag = false;
			$allShowFlag = false;

			$maincontent = null;
			$maincontent .= "<!--{_message_}-->";
			$maincontent .= "\n";
			$maincontent .= _GetFormTable($mode, $xmlList, $info, $tabindex, $loginInfo, $message, $errorFlag, $allShowFlag);


			$allErrorFlag = false;

			$buf = null;
			$maincontent = str_replace('{form_info_cmp_board_name}', $buf, $maincontent);

			//合同会社設立情報[出資金]
			$mode4Promoter = 2;
			$buf = _CreateTableInput4LlcPromoterInvestment($mode4Promoter, $xmlList, $info, $tabindex);
			$maincontent = str_replace('{form_info_llc_promoter_investment}', $buf, $maincontent);
			if (preg_match('/class=\\"requiredMessage\\"/', $buf)) {
				$allErrorFlag = true;
			}

			foreach ($xmlList as $xKey => $xmlInfo) {
				$repKey = null;
				switch ($xKey) {
					case 'tbl_company_name';
						$repKey = '<!--{_form_info_llc_name_}-->';
						break;
					case 'tbl_company_capital';
						$repKey = '<!--{_form_info_llc_capital_}-->';
						break;
					case 'tbl_company_address';
						$repKey = '<!--{_form_info_llc_address_}-->';
						break;
					case 'tbl_company_purpose';
						$repKey = '<!--{_form_info_llc_purpose_}-->';
						break;
					case 'tbl_company_board_base';
						$repKey = '<!--{_form_info_llc_board_base_}-->';
						break;
					case 'tbl_company_board';
						$repKey = '<!--{_form_info_llc_board_name_}-->';
						break;
					case 'tbl_company_promoter';
						$repKey = '<!--{_form_info_llc_promoter_}-->';
						break;
					case 'tbl_company_promoter_investment';
						$repKey = '<!--{_form_info_llc_promoter_investment_}-->';
						break;
					default:
						continue 2;
				}

				$bufXmlList = array();
				$bufXmlList[$xKey] = $xmlInfo;
				//入力値チェック
				$bufMessage = null;
				switch ($xKey) {
					case 'tbl_company_promoter':
						//株式会社設立情報[発起人]
						$bufMessage .= _CheackInput4LlcPromoter($bufXmlList, $info);
						break;
					default:
						$bufMessage .= _CheackInputAll($bufXmlList, $info);
						break;
				}
				if (!_IsNull($bufMessage)) {
					$allErrorFlag = true;
					$buf = null;
					$buf .= "<div class=\"requiredMessage\">";
					$buf .= "未入力項目があります。";//.$bufMessage;
					$buf .= "</div>";
					$buf .= "\n";
					$maincontent = str_replace($repKey, $buf, $maincontent);
				}
			}

			$buf = null;
			$maincontent = str_replace('<!--{_message_}-->', $buf, $maincontent);
			break;
	}

	//定款認証
	$article = null;
	$article .= "<h4>";
	$article .= "<a href=\"".$baseUrl.$articleUrl."\" title=\"定款認証\">定款認証</a>";
	$article .= "</h4>";
	$article .= "\n";
	if (isset($info['update']['tbl_company']['cmp_article_course_id']) && !_IsNull($info['update']['tbl_company']['cmp_article_course_id'])) {
		$article .= "<div class=\"list\">";
		$article .= "\n";
		$article .= "<div class=\"info\">";
		$article .= $mstArticleCourseList[$info['update']['tbl_company']['cmp_article_course_id']]['name'];
		$article .= "</div>";
		$article .= "\n";
		$article .= "</div>";
		$article .= "\n";
	} else {
		$article .= "<div class=\"requiredMessage\">";
		$article .= "未入力項目があります。";
		$article .= "</div>";
		$article .= "\n";
	}


	$res .= "<div id=\"sd_company\">";
	$res .= "\n";
	$res .= "<h2>";
	$res .= "現在の入力状況";
	$res .= "</h2>";
	$res .= "\n";

	$res .= "<div class=\"sd_cp_info\">";
	$res .= "\n";
	$res .= "<h3>";
	$res .= $title;
	$res .= "</h3>";
	$res .= "\n";
//(2011/10/26) 未使用になった。
//	$res .= $article;
	$res .= $maincontent;
	$res .= "<div class=\"link\">";
	$res .= "<a href=\"".$baseUrl.$lastUrl."\" title=\"詳細\">";
	$res .= "詳細&gt;&gt;";
	$res .= "</a>";
	$res .= "</div>";
	$res .= "\n";

	$res .= "</div><!-- End sd_cp_info -->";
	$res .= "\n";

	$res .= "</div><!-- End sd_company -->";


	_Log("[_GetCompanyInfoHtml] 結果 = '".$res."'");
	_Log("[_GetCompanyInfoHtml] end.");
	return $res;
}


/**
 * ユーザー_会社_関連付の一覧を作成する。
 *
 * @param	int		$userId				ユーザーID
 * @param	int		$companyTypeId		会社タイプID
 * @param	boolean	$undeleteOnly		未削除データのみ取得するか？{true:未削除データ対象/false:全データ対象}
 * @return	string	html文字列{null:取得できなかった場合}
 * @access	public
 * @since
 */
function _GetUserCompanyRelationHtml($userId, $companyTypeId, $undeleteOnly = true) {

	_Log("[_GetUserCompanyRelationHtml] start.");

	_Log("[_GetUserCompanyRelationHtml] (param) ユーザーID = '".$userId."'");
	_Log("[_GetUserCompanyRelationHtml] (param) 会社タイプID = '".$companyTypeId."'");
	_Log("[_GetUserCompanyRelationHtml] (param) 未削除データのみ取得するか？{true:未削除データ対象/false:全データ対象} = '".$undeleteOnly."'");


	$res = null;

	if (_IsNull($userId)) {
		_Log("[_GetUserCompanyRelationHtml] ユーザーID未設定。");
		_Log("[_GetUserCompanyRelationHtml] 結果 = '".$res."'");
		_Log("[_GetUserCompanyRelationHtml] end.");
		return $res;
	}

	if (_IsNull($companyTypeId)) {
		_Log("[_GetUserCompanyRelationHtml] 会社タイプID未設定。");
		_Log("[_GetUserCompanyRelationHtml] 結果 = '".$res."'");
		_Log("[_GetUserCompanyRelationHtml] end.");
		return $res;
	}

	$url = "/user/set/";

	$buf = null;
	$bufEdit = null;

	//ユーザー_会社_関連付テーブルを検索する。
	$condition = array();
	$condition['usr_cmp_rel_user_id'] = $userId;		//ユーザーID
	$order = "usr_cmp_rel_company_id";					//ソート順=会社IDの昇順(なんでもいいけど…)
	$tblUserCompanyRelationList = _DB_GetListByAssociative('tbl_user_company_relation', 'usr_cmp_rel_company_id', null, $condition, $undeleteOnly, $order, 'usr_cmp_rel_del_flag');
	if (!_IsNull($tblUserCompanyRelationList)) {
		//会社テーブルを検索する。
		$condition = array();
		$condition['cmp_company_id'] = $tblUserCompanyRelationList;		//会社ID
		$condition['cmp_company_type_id'] = $companyTypeId;				//会社タイプID
		$order = "cmp_company_id desc";									//ソート順=会社IDの降順
		$tblCompanyList = _DB_GetList('tbl_company', $condition, $undeleteOnly, $order, 'cmp_del_flag');
		if (!_IsNull($tblCompanyList)) {
			foreach ($tblCompanyList as $tcKey => $tblCompanyInfo) {
				$cmpCompanyName = "<会社名未設定>";
				if (!_IsNull($tblCompanyInfo['cmp_company_name'])) {
					$cmpCompanyName = $tblCompanyInfo['cmp_company_name'];
					$cmpCompanyName = _SubStr($cmpCompanyName, 15);
				}
				$cmpCompanyName = htmlspecialchars($cmpCompanyName, ENT_QUOTES);

				//編集対象の会社IDか？
				if ($tblCompanyInfo['cmp_company_id'] == $_SESSION[SID_LOGIN_USER_COMPANY][$companyTypeId]) {
					$bufEdit .= "<li>";
					$bufEdit .= "<a href=\"".$url."?id=".$tblCompanyInfo['cmp_company_id']."\">";
					$bufEdit .= "<span class=\"edit\">[編集中]</span>";
					$bufEdit .= $cmpCompanyName;
					$bufEdit .= "</a>";
					$bufEdit .= "</li>";
					$bufEdit .= "\n";
				} else {
					$buf .= "<li>";
					$buf .= "<a href=\"".$url."?id=".$tblCompanyInfo['cmp_company_id']."\">";
					$buf .= $cmpCompanyName;
					$buf .= "</a>";
					$buf .= "</li>";
					$buf .= "\n";
				}
			}
		}
	}

	$res .= "<ul class=\"edit\">";
	$res .= "\n";
	$res .= $bufEdit;
	$res .= "<li>";
	$res .= "<a href=\"".$url."?type_id=".$companyTypeId."\">";
	$res .= "新規登録";
	$res .= "</a>";
	$res .= "</li>";
	$res .= "\n";
	$res .= "</ul>";
	$res .= "\n";
	$res .= "<ul class=\"other\">";
	$res .= "\n";
	$res .= $buf;
	$res .= "</ul>";


	_Log("[_GetUserCompanyRelationHtml] 結果 = '".$res."'");
	_Log("[_GetUserCompanyRelationHtml] end.");
	return $res;
}


?>
